---
title: "Wrangling categorical variables in R"
subtitle: "EcoDataSci-TLV"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["default", "custom-fonts.css"]
    nature:
      highlightStyle: github
      highlightLines: true
      ratio: '16:9'
      beforeInit: "https://platform.twitter.com/widgets.js"
---

```{r setup, include=FALSE}
library(knitr)
library(tidyverse)
options(htmltools.dir.version = FALSE,
        tibble.width = 70)
opts_chunk$set(
  fig.width = 6.5,
  fig.height = 4.5,
  fig.align = "center"
)
theme_set(theme_bw() +
            theme(text = element_text(size = 20))) 
```

# What are factors?

R's representation of categorical variable. Consists of:

1. A set of values
2. An ordered set of valid levels

```{r}
eyes <- factor(c("blue", "green", "green"),
               levels = c("blue", "brown", "green"))
eyes
```

---
# Why care?

It's easy to get tripped up by factors if you don't understand how they work

**The "stealth factor":** `read.csv()` automatically converts all character columns to `factor` unless you specify `stringsAsFactors = FALSE`

---

[![](https://pbs.twimg.com/media/CL5lKZUUYAAWSR7.jpg)](https://twitter.com/JennyBryan/status/630052228624068609)

---

background-image: url(img/numeric-factors.jpg)
background-position: center
background-size: auto 100% 

---

```{r echo = FALSE}
library(tidyverse)
a <- tibble(name = c("Alon", "Ela", "Shaked"),
            drink = factor(c("coffee", "beer", "beer")))

b <- tibble(name = c("Oren", "Erez"),
            drink = factor(c("coffee", "lemonade")))
```

```{r}
a
b
```

---

```{r}
# handles factor magic for you
rbind(a, b)
```

---

```{r}
# fails miserably
c(a$drink, b$drink)
```

---

```{r}
# reminds you to pay attention!
bind_rows(a, b)
```

---

class: center, middle

![](https://github.com/tidyverse/forcats/blob/master/man/figures/logo.png?raw=true)

```{r}
library(tidyverse)

# or if you only want to load forcats:
# library(forcats)
```

---

```{r message = FALSE}
pokemon <- read_csv("data/pokemon.csv")
pokemon
```

---

```{r}
pokemon %>%
  ggplot(aes(type_1)) +
  geom_bar() + coord_flip()
```

---

```{r}
pokemon %>%
  mutate(type_1 = fct_infreq(type_1)) %>% #<<
  ggplot(aes(type_1)) +
  geom_bar() + coord_flip()
```

---

```{r}
pokemon %>%
  mutate(type_1 = fct_infreq(type_1),
         type_1 = fct_rev(type_1)) %>% #<<
  ggplot(aes(type_1)) +
  geom_bar() + coord_flip()
```

---

```{r}
pokemon %>%
  mutate(type_1 = fct_lump(type_1, 5), #<<
         type_1 = fct_infreq(type_1),
         type_1 = fct_rev(type_1)) %>% 
  ggplot(aes(type_1)) +
  geom_bar() + coord_flip()
```
---

```{r}
pokemon %>%
  mutate(type_1 = fct_lump(type_1, 5), 
         type_1 = fct_infreq(type_1),
         type_1 = fct_rev(type_1),
         type_1 = fct_relevel(type_1, "Other")) %>% #<<
  ggplot(aes(type_1)) +
  geom_bar() + coord_flip()
```

---

```{r}
pokemon %>%
  ggplot(aes(generation, attack)) +
  geom_boxplot()
```

---

```{r}
pokemon %>%
  mutate(generation = as.factor(generation)) %>% #<<
  ggplot(aes(generation, attack)) +
  geom_boxplot()
```

---

```{r}
pokemon %>%
  mutate(generation = as.factor(generation)) %>%
  mutate(generation = fct_reorder(generation, attack)) %>% #<<
  ggplot(aes(generation, attack)) +
  geom_boxplot()
```

---

```{r}
pokemon %>%
  count(generation, body_style)
```

---

Get ready for some balloon plots:

```{r}
library(ggpubr)

options(
  ggplot2.continuous.color = "viridis",
  ggplot2.continuous.fill = "viridis"
)
```

---

```{r}
pokemon %>%
  count(generation, body_style) %>%
  ggballoonplot(x = "generation", y = "body_style",
                size = "n", fill = "n") 
```

---

```{r}
pokemon %>%
  mutate(generation = as.factor(generation)) %>% #<<
  count(generation, body_style) %>%
  ggballoonplot(x = "generation", y = "body_style",
                size = "n", fill = "n")
```

---
# Why care?

- important for models and visualization
- easy to get tripped up

# When is it important 

- binding two dataframes (if levels don't exist, it gets messed up)
- conversion to numeric - can't go directly or else you get the underlying integer codes
- for-loops - introducing new levels may mess things up

# stringsAsFactors = FALSE
